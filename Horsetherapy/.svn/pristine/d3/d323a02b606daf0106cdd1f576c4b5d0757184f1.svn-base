package sepm.ss13.e0828.test;

import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;

import java.sql.SQLException;
import java.util.List;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import sepm.ss13.e0828.dao.Connector;
import sepm.ss13.e0828.dao.DBHorseDAO;
import sepm.ss13.e0828.dao.HorseDAO;
import sepm.ss13.e0828.dao.exceptions.HorseNotExistentException;
import sepm.ss13.e0828.dao.exceptions.NoClassGivenException;
import sepm.ss13.e0828.dao.exceptions.PersistenceException;
import sepm.ss13.e0828.dao.exceptions.UnacceptedValueException;
import sepm.ss13.e0828.domain.Horse;
import sepm.ss13.e0828.domain.HorseDeleteData;
import sepm.ss13.e0828.domain.HorseQueryData;

public class DBHorseDAOTest {

	private HorseDAO horsedao;
	private Horse testHorse = null;
	
	@Before
	public void setUp(){
		horsedao = new DBHorseDAO();
		
		testHorse = new Horse();
		testHorse.setHorseName("Speedy");
		testHorse.setHorsePhoto("pics/speedy.jpg");
		testHorse.setHorseTherapyprice(16.90f);
		testHorse.setHorseTherapytype(Horse.Therapytype.HIPPOTHERAPIE);
	}
	
	@After
	public void tearDown() throws SQLException{
		Connector.getConnection().rollback();
		Connector.closeConnection();
		testHorse = null;
	}
	
	
	@Test
	public void testGetHorsesCorrect() throws PersistenceException {
		List<Horse> horses = null;
		horses = horsedao.getHorses();		
		assertTrue(horses != null);
	}

	@Test
	public void testCreateHorseCorrect() throws PersistenceException, NoClassGivenException, UnacceptedValueException {
		List<Horse> horses = null;
		horses = horsedao.getHorses();
		int size = horses.size();
		
		horsedao.createHorse(testHorse);
		
		horses = horsedao.getHorses();
		assertTrue( (size+1) == horses.size() );
	}

	@Test(expected = NoClassGivenException.class)
	public void testCreateHorseWithNoHorse() throws PersistenceException, NoClassGivenException, UnacceptedValueException {
		testHorse = null;
		horsedao.createHorse(testHorse);
	}

	
	@Test(expected = UnacceptedValueException.class)
	public void testCreateHorseWithNegativePrice() throws PersistenceException, NoClassGivenException, UnacceptedValueException {
		testHorse.setHorseTherapyprice(-16.90f);
		horsedao.createHorse(testHorse);
	}

	
	@Test
	public void testDeleteHorseCorrect() throws PersistenceException, NoClassGivenException, UnacceptedValueException, HorseNotExistentException {
		horsedao.createHorse(testHorse);

		List<Horse> horses = null;
		horses = horsedao.getHorses();
		int size = horses.size();

		horsedao.deleteHorse( new HorseDeleteData(testHorse.getHorseID()) );
		assertTrue( size > horsedao.getHorses().size());
	}

	@Test(expected = HorseNotExistentException.class)
	public void testDeleteHorseObjectNotAvailable() throws PersistenceException, NoClassGivenException, UnacceptedValueException, HorseNotExistentException {
		horsedao.createHorse(testHorse);
		horsedao.deleteHorse( new HorseDeleteData(testHorse.getHorseID() + 1) );
	}
	
	@Test(expected = NoClassGivenException.class)
	public void testDeleteHorseNoGivenValue() throws PersistenceException, NoClassGivenException, HorseNotExistentException {
		HorseDeleteData delHorse = null;
		horsedao.deleteHorse(delHorse);
	}
	
	@Test
	public void testUpdateHorseCorrect() throws PersistenceException, NoClassGivenException, UnacceptedValueException, HorseNotExistentException {		
		horsedao.createHorse(testHorse);

		testHorse.setHorseTherapyprice(testHorse.getHorseTherapyprice() + 20.0f);
		horsedao.updateHorse(testHorse);
		
		List<Horse> horses = null;
		horses = horsedao.getHorses();
		
		assertTrue( testHorse.getHorseTherapyprice() == horses.get(horses.size()-1).getHorseTherapyprice() );
	}
	
	@Test(expected = UnacceptedValueException.class)
	public void testUpdateHorseNoCorrectValue() throws PersistenceException, NoClassGivenException, UnacceptedValueException, HorseNotExistentException {
		horsedao.createHorse(testHorse);

		testHorse.setHorseTherapyprice(testHorse.getHorseTherapyprice() * (-1) );
		horsedao.updateHorse(testHorse);		
	}

	@Test(expected = HorseNotExistentException.class)
	public void testUpdateHorseHorseNonExistent() throws PersistenceException, NoClassGivenException, UnacceptedValueException, HorseNotExistentException {
		horsedao.createHorse(testHorse);

		testHorse.setHorseTherapyprice(testHorse.getHorseTherapyprice() + 20.0f );
		testHorse.setHorseID(testHorse.getHorseID() + 1);
		
		horsedao.updateHorse(testHorse);	
	}

	@Test(expected = NoClassGivenException.class)
	public void testUpdateNoHorse() throws PersistenceException, NoClassGivenException, HorseNotExistentException, UnacceptedValueException {
		testHorse = null;
		horsedao.updateHorse(testHorse);
	}


	@Test
	public void testGetHorsesByCorrect() throws PersistenceException, NoClassGivenException, UnacceptedValueException {
		horsedao.createHorse(testHorse);
		HorseQueryData query = new HorseQueryData();
		query.setHorseID(testHorse.getHorseID());
		
		List<Horse> horses = horsedao.getHorsesBy( query );
		
		assertTrue( horses.get(0).getHorseName().equals( testHorse.getHorseName()) ); 	
	}
	
	@Test(expected = NoClassGivenException.class)
	public void testGetHorsesByNoQuery() throws PersistenceException, NoClassGivenException, UnacceptedValueException {
		HorseQueryData query = null;
		horsedao.getHorsesBy( query );
	}

	@Test
	public void testGetHorsesByUsageCorrect() throws PersistenceException, NoClassGivenException, UnacceptedValueException {
		horsedao.createHorse(testHorse);
		HorseQueryData query = new HorseQueryData();
		query.setHorseTherapy( testHorse.getHorseTherapytype() );
		
		List<Horse> horses = horsedao.getHorsesByUsage( query );
		
		assertTrue( horses.get(0).getHorseName().equals( testHorse.getHorseName()) ); 		
	}

	@Test(expected = NoClassGivenException.class)
	public void testGetHorsesByUsageNoClass() throws PersistenceException, NoClassGivenException, UnacceptedValueException {
		HorseQueryData query = null;
		horsedao.getHorsesByUsage(query);
	}
	
}
